<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Sincronizador de textos</title>
  <style>
    body { font-family: sans-serif; padding: 2rem; background: #f4f4f4; }
    table { border-collapse: collapse; width: 100%; margin-top: 1rem; }
    th, td { border: 1px solid #ddd; padding: 0.5rem; text-align: left; }
    th { background: #222; color: #fff; }
    .green { background: #d4edda; }
    .red { background: #f8d7da; }
    .yellow { background: #fff3cd; }
    button { padding: 0.5rem 1rem; margin: 1rem 0; font-size: 1rem; cursor: pointer; }
  </style>
</head>
<body>
  <h2>ðŸ”„ Sincronizar textos desde Figma</h2>
  <button onclick="sincronizar()">ðŸš€ Sincronizar</button>

  <table>
    <thead>
      <tr>
        <th>ðŸ§  Nodo</th>
        <th>ðŸŽ¨ Valor Figma</th>
        <th>ðŸ“¦ Valor Repo</th>
        <th>ðŸ“Œ Estado</th>
      </tr>
    </thead>
    <tbody id="tabla-body"></tbody>
  </table>

  <script>
    async function sincronizar() {
      const figmaRes = await fetch("https://spelling-checker-proxy.martin-regas.workers.dev/figma");
      const repoRes = await fetch("https://spelling-checker-proxy.martin-regas.workers.dev/github");

      const figmaJson = await figmaRes.json(); // { strings, conflicts }
      const repoData = await repoRes.json();

      const strings = figmaJson.strings;
      const conflicts = new Set(figmaJson.conflicts);
      const tabla = document.getElementById("tabla-body");
      tabla.innerHTML = "";

      for (const [key, figmaValues] of Object.entries(strings)) {
        const figmaText = figmaValues.join(", ");
        const repoText = repoData[key] ?? "";

        let estado = null;

        if (!repoData.hasOwnProperty(key)) {
          estado = "Nuevo";
        } else if (repoText !== figmaText) {
          estado = "Cambio";
        }

        if (conflicts.has(key)) {
          estado = "Conflicto";
        }

        if (estado) {
          renderRow(tabla, key, figmaText, repoText, estado);
        }
      }

      for (const key of Object.keys(repoData)) {
        if (!strings.hasOwnProperty(key)) {
          renderRow(tabla, key, "", repoData[key], "Eliminado");
        }
      }
    }

    function renderRow(tbody, nodo, figma, repo, estado) {
      const tr = document.createElement("tr");
      tr.className = estado === "Conflicto" ? "yellow" :
                     estado === "Nuevo"     ? "green" :
                     estado === "Eliminado" ? "red"   :
                     estado === "Cambio"    ? "green" : "";

      tr.innerHTML = `
        <td>${nodo}</td>
        <td>${figma}</td>
        <td>${repo}</td>
        <td>${estado}</td>
      `;
      tbody.appendChild(tr);
    }
  </script>
</body>
</html>

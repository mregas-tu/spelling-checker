<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Sincronizador de textos</title>
  <style>
    body { font-family: sans-serif; padding: 2rem; background: #f4f4f4; }
    table { border-collapse: collapse; width: 100%; margin-top: 1rem; }
    th, td { border: 1px solid #ddd; padding: 0.5rem; text-align: left; }
    th { background: #222; color: #fff; }
    .green { background: #d4edda; }
    .red { background: #f8d7da; }
    .yellow { background: #fff3cd; }
    button { padding: 0.5rem 1rem; margin: 1rem 0; font-size: 1rem; cursor: pointer; }
  </style>
</head>
<body>
  <h2>üîÑ Sincronizar textos desde Figma</h2>
  <button onclick="subirCambios()">üöÄ Sincronizar</button>

  <table>
    <thead>
      <tr>
        <th>üß† Nodo</th>
        <th>üé® Valor Figma</th>
        <th>üì¶ Valor Repo</th>
        <th>üìå Estado</th>
      </tr>
    </thead>
    <tbody id="tabla-body"></tbody>
  </table>

  <script>
    let strings = {};
    let conflicts = new Set();
    let repoData = {};
    const API_URL = "https://spelling-checker-proxy.martin-regas.workers.dev";

    window.onload = cargarDatos;

    async function cargarDatos() {
      const figmaRes = await fetch(`${API_URL}/figma`);
      const repoRes = await fetch(`${API_URL}/github`);
      const figmaJson = await figmaRes.json();
      repoData = await repoRes.json();
      strings = figmaJson.strings;
      conflicts = new Set(figmaJson.conflicts);

      const tabla = document.getElementById("tabla-body");
      tabla.innerHTML = "";

      for (const [key, figmaValues] of Object.entries(strings)) {
        const figmaText = figmaValues.join(", ");
        const repoText = repoData[key] ?? "";
        let estado = null;

        if (!repoData.hasOwnProperty(key)) estado = "Nuevo";
        else if (repoText !== figmaText) estado = "Cambio";
        if (conflicts.has(key)) estado = "Conflicto";

        if (estado) renderRow(tabla, key, figmaText, repoText, estado);
      }

      for (const key of Object.keys(repoData)) {
        if (!strings.hasOwnProperty(key)) {
          renderRow(tabla, key, "", repoData[key], "Eliminado");
        }
      }
    }

    function renderRow(tbody, nodo, figma, repo, estado) {
      const tr = document.createElement("tr");
      tr.className = estado === "Conflicto" ? "yellow" :
                     estado === "Nuevo"     ? "green" :
                     estado === "Eliminado" ? "red"   :
                     estado === "Cambio"    ? "green" : "";

      tr.innerHTML = `
        <td>${nodo}</td>
        <td>${figma}</td>
        <td>${repo}</td>
        <td>${estado}</td>
      `;
      tbody.appendChild(tr);
    }

    async function subirCambios() {
      const updated = {};
      const deleted = [];

      for (const [key, values] of Object.entries(strings)) {
        const nuevoValor = values.join(", ");
        const valorViejo = repoData[key];

        if (!repoData.hasOwnProperty(key)) {
          updated[key] = nuevoValor;
        } else if (valorViejo !== nuevoValor) {
          updated[key] = nuevoValor;
        }
      }

      for (const key of Object.keys(repoData)) {
        if (!strings.hasOwnProperty(key)) {
          deleted.push(key);
        }
      }

      const body = JSON.stringify({ updated, deleted });

      const res = await fetch(`${API_URL}/github`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body
      });

      if (res.ok) {
        alert("‚úÖ Cambios subidos correctamente al backend.");
        cargarDatos(); // recarga la tabla
      } else {
        const msg = await res.text();
        alert("‚ùå Error al subir los cambios:\n" + msg);
      }
    }
  </script>
</body>
</html>

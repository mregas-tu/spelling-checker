<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Sync de textos desde Figma</title>
    <style>
      body { font-family: sans-serif; padding: 2rem; background: #f4f4f4; }
      pre { background: #fff; padding: 1rem; border-radius: 8px; max-height: 50vh; overflow: auto; }
      button { padding: 0.5rem 1rem; margin: 1rem 0; font-size: 1rem; cursor: pointer; }
      .green { background: #d4edda; padding: 0.5rem; border-radius: 5px; margin-bottom: 0.5rem; }
      .red { background: #f8d7da; padding: 0.5rem; border-radius: 5px; margin-bottom: 0.5rem; }
      .yellow { background: #fff3cd; padding: 0.5rem; border-radius: 5px; margin-bottom: 0.5rem; }
    </style>
  </head>
  <body>
    <h2>🔄 Sincronizar textos desde Figma</h2>
    <button onclick="startSync()">🚀 Sincronizar</button>
    <div id="warnings"></div>
    <div id="changes"></div>
    <div id="deleted"></div>
    <pre id="log">Esperando acción...</pre>

    <script>
      const API_BASE = "https://spelling-checker-proxy.martin-regas.workers.dev";

      async function compareOnly() {
        await sync(false);
      }

      async function startSync() {
        await sync(true);
      }

      async function sync(doUpdate) {
        const log = (msg) => {
          document.getElementById("log").textContent += "\n" + msg;
        };
        document.getElementById("log").textContent = "🟡 Iniciando sincronización...";
        document.getElementById("warnings").innerHTML = "";
        document.getElementById("changes").innerHTML = "";
        document.getElementById("deleted").innerHTML = "";

        try {
          log("📥 Obteniendo textos de Figma...");
          const figma = await fetch(`${API_BASE}/figma`).then(r => r.json());

          log("📤 Obteniendo textos del repo...");
          const repo = await fetch(`${API_BASE}/github`).then(r => r.json());

          const updated = {};
          const warnings = [];
          const deleted = [];

          const figmaKeys = Object.keys(figma);
          const repoKeys = Object.keys(repo);

          for (const key of figmaKeys) {
            if (repo[key] && repo[key] !== figma[key]) {
              updated[key] = figma[key];
              if (figmaKeys.filter(k => k === key).length > 1) {
                warnings.push(key);
              }
            }
          }

          for (const key of repoKeys) {
            if (!(key in figma)) {
              deleted.push(key);
            }
          }

          if (Object.keys(updated).length === 0 && deleted.length === 0 && warnings.length === 0) {
            log("✅ Todo está sincronizado.");
            return;
          }

          if (warnings.length) {
            document.getElementById("warnings").innerHTML = "<h3>🟨 Warnings (duplicados):</h3>" + warnings.map(k => `<div class='yellow'>${k}</div>`).join("");
          }

          if (Object.keys(updated).length) {
            document.getElementById("changes").innerHTML = "<h3>✅ Cambios detectados:</h3>" + Object.entries(updated).map(([k,v]) => `<div class='green'><strong>${k}</strong>: ${v}</div>`).join("");
          }

          if (deleted.length) {
            document.getElementById("deleted").innerHTML = "<h3>🟥 Eliminados:</h3>" + deleted.map(k => `<div class='red'>${k}</div>`).join("");
          }

          if (doUpdate && confirm("¿Querés actualizar el archivo en el repo?")) {
            const result = await fetch(`${API_BASE}/github`, {
              method: "PUT",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ updated, deleted })
            }).then(r => r.json());

            log("📦 Resultado del update:\n" + JSON.stringify(result, null, 2));
          } else {
            log("❌ Cancelado por el usuario.");
          }

        } catch (e) {
          log("❌ Error:\n" + e.message);
        }
      }
    window.onload = compareOnly;
</script>
  </body>
</html>
